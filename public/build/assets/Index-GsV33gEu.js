import{b as W,r as i,j as e,H as P}from"./app-_tcWvRHw.js";import{D as I}from"./DashboardLayout-Dotb40vo.js";import"./AnimatedIcon-D_as9RWF.js";import"./index-D3vds0s7.js";import"./index-DoyJDsUh.js";function Q(){const p=W().props.auth?.user,[o,r]=i.useState(!1),[k,l]=i.useState(""),[f,L]=i.useState([]),[u,q]=i.useState(""),[E,S]=i.useState([]),[F,d]=i.useState(!1),[n,c]=i.useState({subject:"",description:"",priority:"normal",assignee_user_id:""}),[m,C]=i.useState(""),[h,X]=i.useState(null),[j,_]=i.useState([]),[y,A]=i.useState(""),g=i.useRef(null),T=()=>document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",x=async t=>{const s=await t.text();try{return s?JSON.parse(s):{}}catch{return{}}},v=()=>{r(!0),l(""),fetch(route("support.tickets.data",{q:u}),{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(async t=>{const s=await x(t);if(!t.ok)throw new Error(s?.message||"Failed to load tickets");L(Array.isArray(s?.tickets)?s.tickets:[])}).catch(t=>l(t?.message||"Failed to load tickets")).finally(()=>r(!1))},O=()=>{fetch(route("support.tickets.assignees"),{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(async t=>{const s=await x(t);if(!t.ok)throw new Error("Failed");S(Array.isArray(s?.assignees)?s.assignees:[])}).catch(()=>S([]))},w=t=>{t&&(r(!0),l(""),fetch(route("support.tickets.show",{ticket:t}),{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(async s=>{const a=await x(s);if(!s.ok)throw new Error(a?.message||"Failed to load ticket");X(a?.ticket||null),_(Array.isArray(a?.messages)?a.messages:[])}).catch(s=>l(s?.message||"Failed to load ticket")).finally(()=>r(!1)))};i.useEffect(()=>{v(),O()},[]),i.useEffect(()=>{g.current&&(g.current.scrollTop=g.current.scrollHeight)},[j.length]);const D=()=>{r(!0),l(""),fetch(route("support.tickets.store"),{method:"POST",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":T(),Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({subject:n.subject,description:n.description,priority:n.priority,assignee_user_id:n.assignee_user_id||null})}).then(async t=>{const s=await x(t);if(!t.ok)throw new Error(s?.message||s?.errors?.subject?.[0]||"Failed to create ticket");d(!1),c({subject:"",description:"",priority:"normal",assignee_user_id:""}),v(),s?.ticket_id&&(C(String(s.ticket_id)),w(String(s.ticket_id)))}).catch(t=>l(t?.message||"Failed to create ticket")).finally(()=>r(!1))},R=()=>{const t=y.trim();if(!t||!m)return;const s={id:`tmp-${Date.now()}`,message:t,created_at:new Date().toISOString(),user:{id:p?.id,name:p?.name,email:p?.email}};_(a=>[...a,s]),A(""),r(!0),l(""),fetch(route("support.tickets.messages.store",{ticket:m}),{method:"POST",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":T(),Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({message:t})}).then(async a=>{const b=await x(a);if(!a.ok)throw new Error(b?.message||b?.errors?.message?.[0]||"Failed");w(m),v()}).catch(a=>l(a?.message||"Failed to send")).finally(()=>r(!1))},N=i.useMemo(()=>{const t=u.trim().toLowerCase();return t?f.filter(s=>{const a=String(s?.subject||"").toLowerCase(),b=String(s?.status||"").toLowerCase(),M=String(s?.priority||"").toLowerCase();return a.includes(t)||b.includes(t)||M.includes(t)}):f},[f,u]),H=t=>{const s=String(t||"open"),a="inline-flex rounded-full px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider ";return s==="resolved"||s==="closed"?a+"bg-emerald-100 text-emerald-700":s==="in_progress"?a+"bg-amber-100 text-amber-700":a+"bg-slate-100 text-slate-700"};return e.jsxs(I,{title:"Tickets",breadcrumbs:["Support","Tickets"],children:[e.jsx(P,{title:"Tickets"}),k?e.jsx("div",{className:"mb-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-[12px] text-red-700",children:k}):null,F?e.jsx("div",{className:"fixed inset-0 z-[90] flex items-center justify-center bg-slate-950/40 p-4",children:e.jsxs("div",{className:"w-full max-w-2xl overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-xl",children:[e.jsx("div",{className:"border-b border-slate-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-slate-900",children:"Create ticket"}),e.jsx("div",{className:"mt-1 text-[12px] text-slate-500",children:"Create a private ticket for support. Only you, the assignee, and Super Admin can view it."})]}),e.jsx("button",{type:"button",onClick:()=>d(!1),className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-[12px] font-semibold text-slate-700 hover:bg-slate-50",children:"Close"})]})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-[11px] font-semibold text-slate-700",children:"Subject"}),e.jsx("input",{value:n.subject,onChange:t=>c(s=>({...s,subject:t.target.value})),className:"mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-[12px]"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[11px] font-semibold text-slate-700",children:"Priority"}),e.jsxs("select",{value:n.priority,onChange:t=>c(s=>({...s,priority:t.target.value})),className:"mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-[12px]",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"high",children:"High"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[11px] font-semibold text-slate-700",children:"Target employee (optional)"}),e.jsxs("select",{value:n.assignee_user_id,onChange:t=>c(s=>({...s,assignee_user_id:t.target.value})),className:"mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-[12px]",children:[e.jsx("option",{value:"",children:"Super Admin / Unassigned"}),E.map(t=>e.jsxs("option",{value:t.id,children:[t.name," ",t.email?`(${t.email})`:""]},t.id))]})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"text-[11px] font-semibold text-slate-700",children:"Description"}),e.jsx("textarea",{value:n.description,onChange:t=>c(s=>({...s,description:t.target.value})),rows:4,className:"mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-[12px]"})]})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-2 border-t border-slate-200 px-6 py-4",children:[e.jsx("button",{type:"button",onClick:()=>d(!1),disabled:o,className:"rounded-xl border border-slate-200 bg-white px-4 py-2 text-[12px] font-semibold text-slate-700 hover:bg-slate-50 disabled:opacity-60",children:"Cancel"}),e.jsx("button",{type:"button",onClick:D,disabled:o,className:"rounded-xl bg-slate-900 px-4 py-2 text-[12px] font-semibold text-white hover:bg-slate-800 disabled:opacity-60",children:o?"Saving…":"Create ticket"})]})]})}):null,e.jsxs("div",{className:"grid gap-4 overflow-hidden rounded-2xl border border-slate-200 bg-white lg:grid-cols-[380px,1fr]",children:[e.jsxs("div",{className:"border-b border-slate-200 lg:border-b-0 lg:border-r",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[12px] font-semibold text-slate-900",children:"My tickets"}),e.jsx("div",{className:"mt-0.5 text-[11px] text-slate-500",children:o?"Loading…":`${N.length} tickets`})]}),e.jsx("button",{type:"button",onClick:()=>d(!0),className:"rounded-xl bg-slate-900 px-3 py-2 text-[11px] font-semibold text-white hover:bg-slate-800",children:"Create"})]}),e.jsx("div",{className:"px-4 pb-4",children:e.jsx("input",{value:u,onChange:t=>q(t.target.value),placeholder:"Search tickets",className:"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-[12px] text-slate-900 placeholder:text-slate-400 focus:border-slate-900 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-900/10"})}),e.jsx("div",{className:"max-h-[620px] overflow-auto p-2",children:N.length?e.jsx("div",{className:"grid gap-1",children:N.map(t=>{const s=String(t.id)===String(m);return e.jsx("button",{type:"button",onClick:()=>{C(String(t.id)),w(String(t.id))},className:"w-full rounded-xl px-3 py-3 text-left transition "+(s?"bg-slate-50":"hover:bg-slate-50"),children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-[12px] font-semibold text-slate-900",children:t.subject}),e.jsx("div",{className:"mt-1 text-[11px] text-slate-500",children:t.assignee?`Assigned: ${t.assignee.name}`:"Unassigned"})]}),e.jsxs("div",{className:"shrink-0 text-right",children:[e.jsx("div",{className:H(t.status),children:t.status}),e.jsx("div",{className:"mt-1 text-[10px] text-slate-500",children:t.updated_at?new Date(t.updated_at).toLocaleDateString():""})]})]})},t.id)})}):e.jsx("div",{className:"px-3 py-6 text-center text-[12px] text-slate-500",children:"No tickets yet."})})]}),e.jsx("div",{className:"flex min-h-[620px] flex-col",children:h?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"border-b border-slate-200 px-4 py-3",children:[e.jsx("div",{className:"text-[12px] font-semibold text-slate-900",children:h.subject}),e.jsxs("div",{className:"mt-1 text-[11px] text-slate-500",children:["Status: ",e.jsx("span",{className:"font-semibold",children:h.status}),"  •  ","Priority: ",e.jsx("span",{className:"font-semibold",children:h.priority})]})]}),e.jsx("div",{ref:g,className:"flex-1 overflow-auto bg-slate-50 p-4",children:j.length?e.jsx("div",{className:"grid gap-2",children:j.map(t=>{const s=String(t?.user?.id||"")===String(p?.id||"");return e.jsx("div",{className:s?"flex justify-end":"flex justify-start",children:e.jsxs("div",{className:s?"max-w-[85%] rounded-2xl bg-slate-900 px-4 py-3 text-[12px] text-white":"max-w-[85%] rounded-2xl bg-white px-4 py-3 text-[12px] text-slate-900",children:[e.jsx("div",{children:t.message}),e.jsx("div",{className:s?"mt-1 text-[10px] text-white/70":"mt-1 text-[10px] text-slate-500",children:t.created_at?new Date(t.created_at).toLocaleString():""})]})},t.id)})}):e.jsx("div",{className:"text-[12px] text-slate-500",children:"No messages yet."})}),e.jsxs("div",{className:"border-t border-slate-200 bg-white p-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{value:y,onChange:t=>A(t.target.value),placeholder:"Write a message",className:"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-[12px] text-slate-900 placeholder:text-slate-400 focus:border-slate-900 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-900/10",onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),R())}}),e.jsx("button",{type:"button",onClick:R,disabled:o||!y.trim(),className:"rounded-xl bg-emerald-500 px-4 py-2 text-[12px] font-semibold text-white hover:bg-emerald-600 disabled:opacity-50",children:"Send"})]}),e.jsx("div",{className:"mt-2 flex items-center justify-end text-[10px] text-slate-500",children:o?"Working…":""})]})]}):e.jsx("div",{className:"flex flex-1 items-center justify-center bg-slate-50 p-6",children:e.jsxs("div",{className:"w-full max-w-md rounded-3xl border border-slate-200 bg-white p-6 text-center shadow-sm",children:[e.jsx("div",{className:"text-lg font-semibold text-slate-900",children:"Support Tickets"}),e.jsx("div",{className:"mt-2 text-[12px] text-slate-500",children:"Create a private ticket to get help. Only you, the assignee and Super Admin can view it."}),e.jsx("button",{type:"button",onClick:()=>d(!0),className:"mt-6 rounded-xl bg-slate-900 px-4 py-2 text-[12px] font-semibold text-white hover:bg-slate-800",children:"Create ticket"})]})})})]})]})}export{Q as default};
