import{r as l,j as t,H,L as W}from"./app-_tcWvRHw.js";import{G as $}from"./GuestLayout-DZSGXUEb.js";function q(){const[o,j]=l.useState(!1),[_,y]=l.useState(!1),[w,u]=l.useState(""),[h,v]=l.useState([]),[d,N]=l.useState(""),[n,m]=l.useState(null),[I,E]=l.useState(null),[R,S]=l.useState(!1),[i,g]=l.useState([]),[p,C]=l.useState(!0),c=l.useRef(null),T=e=>{const a=`; ${document.cookie}`.split(`; ${e}=`);return a.length===2?a.pop().split(";").shift():""},F=()=>document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",L=()=>{const e=T("XSRF-TOKEN");try{return e?decodeURIComponent(e):""}catch{return e||""}},k=async e=>{const s=await e.text();try{return s?JSON.parse(s):{}}catch{return{}}},f=()=>{y(!0),u(""),fetch(route("helpdesk.chat.messages"),{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(async e=>{const s=await k(e);if(!e.ok)throw new Error(s?.message||"Failed to load messages");v(Array.isArray(s?.messages)?s.messages:[]),E(new Date().toISOString())}).catch(e=>u(e?.message||"Failed to load messages")).finally(()=>y(!1))};l.useEffect(()=>{f()},[]),l.useEffect(()=>{const e=window.setInterval(()=>{o||p&&f()},3e3);return()=>window.clearInterval(e)},[o,p]),l.useEffect(()=>{c.current&&p&&(c.current.scrollTop=c.current.scrollHeight)},[h.length,p]),l.useMemo(()=>d.trim().length>0&&!o,[d,o]);const O=e=>{const s=String(e?.type||""),a=s.startsWith("image/")||s.startsWith("video/")?"media":s.startsWith("audio/")?"audio":"document";return{id:`local-${e.name}-${e.size}-${e.lastModified}`,kind:a,original_name:e.name,mime:s,size:e.size,url:URL.createObjectURL(e),local:!0}},b=e=>{const s=Array.from(e||[]);s.length&&g(a=>[...a,...s])},A=()=>{const e=d.trim();if(!e&&i.length===0)return;const s={id:`tmp-${Date.now()}`,sender:"user",message:e,created_at:new Date().toISOString(),attachments:i.map(O),reply_to:n?{id:n.id,sender:n.sender,message:n.message,created_at:n.created_at}:null};v(r=>[...r,s]),N(""),m(null),g([]),S(!1),j(!0),u("");const a=new FormData;a.append("message",e||""),n?.id&&a.append("reply_to_id",String(n.id)),i.forEach(r=>a.append("files[]",r)),fetch(route("helpdesk.chat.store"),{method:"POST",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":F(),"X-XSRF-TOKEN":L(),Accept:"application/json"},body:a}).then(async r=>{const x=await k(r);if(!r.ok)throw new Error(x?.message||x?.errors?.message?.[0]||"Failed to send");f()}).catch(r=>u(r?.message||"Failed to send")).finally(()=>j(!1))},D=e=>{g(s=>s.filter((a,r)=>r!==e))},X=(e,s)=>{const a=Array.isArray(e)?e:[];return a.length?t.jsx("div",{className:"mb-2 grid gap-2",children:a.map(r=>{const x=r.original_name||"Attachment";return r.kind==="media"&&String(r.mime||"").startsWith("image/")?t.jsx("a",{href:r.url,target:"_blank",rel:"noreferrer",className:"block overflow-hidden rounded-xl",children:t.jsx("img",{src:r.url,alt:x,className:"max-h-56 w-full object-cover"})},r.id):r.kind==="audio"?t.jsx("div",{className:s?"rounded-xl bg-white/10 p-2":"rounded-xl bg-white p-2",children:t.jsx("audio",{controls:!0,src:r.url,className:"w-full"})},r.id):t.jsxs("a",{href:r.url,target:"_blank",rel:"noreferrer",className:"flex items-center justify-between gap-3 rounded-xl px-3 py-2 text-[11px] "+(s?"bg-white/10 text-white":"bg-white text-slate-900"),children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("div",{className:"truncate font-semibold",children:x}),t.jsx("div",{className:s?"mt-0.5 text-[10px] text-white/70":"mt-0.5 text-[10px] text-slate-500",children:r.mime||"document"})]}),t.jsx("div",{className:s?"text-[10px] text-white/70":"text-[10px] text-slate-500",children:"Open"})]},r.id)})}):null};return t.jsxs($,{subtitle:"HELPDESK",title:"Support chat",description:"Send a message to our support team. Your messages will remain here even if you leave and come back.",footer:t.jsx("div",{className:"text-xs text-slate-500",children:t.jsx(W,{href:route("banned"),className:"font-semibold text-slate-700 hover:text-slate-900",children:"Back to banned page"})}),children:[t.jsx(H,{title:"Helpdesk Chat"}),w?t.jsx("div",{className:"mb-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-xs text-red-700",children:w}):null,t.jsxs("div",{className:"rounded-2xl border border-slate-200 bg-white",children:[t.jsx("div",{ref:c,className:"max-h-[320px] overflow-auto p-4",onScroll:()=>{const e=c.current;if(!e)return;const s=e.scrollTop+e.clientHeight>=e.scrollHeight-24;C(s)},children:h.length?t.jsx("div",{className:"grid gap-3",children:h.map(e=>t.jsx("div",{className:e.sender==="user"?"flex justify-end":"flex justify-start",children:t.jsxs("div",{role:"button",tabIndex:0,onClick:()=>{!e?.id||String(e.id).startsWith("tmp-")||m(e)},onKeyDown:s=>{if(s.key==="Enter"){if(!e?.id||String(e.id).startsWith("tmp-"))return;m(e)}},className:"max-w-[85%] rounded-2xl px-4 py-3 text-xs leading-relaxed "+(e.sender==="user"?"bg-slate-900 text-white":"bg-slate-100 text-slate-900"),children:[e.reply_to?t.jsxs("div",{className:e.sender==="user"?"mb-2 rounded-xl bg-white/10 px-3 py-2":"mb-2 rounded-xl bg-white px-3 py-2",children:[t.jsxs("div",{className:e.sender==="user"?"text-[10px] font-bold text-white/80":"text-[10px] font-bold text-slate-700",children:["Replying to ",e.reply_to.sender]}),t.jsx("div",{className:e.sender==="user"?"mt-0.5 text-[10px] text-white/70":"mt-0.5 text-[10px] text-slate-500",children:String(e.reply_to.message||"").slice(0,140)})]}):null,X(e.attachments,e.sender==="user"),e.message?t.jsx("div",{children:e.message}):null,t.jsx("div",{className:e.sender==="user"?"mt-1 text-[10px] text-white/70":"mt-1 text-[10px] text-slate-500",children:e.created_at?new Date(e.created_at).toLocaleTimeString():""})]})},e.id))}):t.jsx("div",{className:"text-xs text-slate-500",children:"No messages yet. Write your first message below."})}),t.jsxs("div",{className:"border-t border-slate-200 p-4",children:[n?t.jsxs("div",{className:"mb-3 flex items-start justify-between gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsxs("div",{className:"text-[10px] font-bold text-slate-700",children:["Replying to ",n.sender]}),t.jsx("div",{className:"mt-0.5 truncate text-[11px] text-slate-600",children:n.message})]}),t.jsx("button",{type:"button",onClick:()=>m(null),className:"rounded-lg border border-slate-200 bg-white px-2 py-1 text-[10px] font-semibold text-slate-700 hover:bg-slate-50",children:"X"})]}):null,i.length?t.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:i.map((e,s)=>t.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-[10px] font-semibold text-slate-700",children:[t.jsx("span",{className:"max-w-[180px] truncate",children:e.name}),t.jsx("button",{type:"button",onClick:()=>D(s),className:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-[10px] font-semibold text-slate-700 hover:bg-slate-100",children:"X"})]},`${e.name}-${s}`))}):null,t.jsxs("div",{className:"relative flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-2 py-1.5",children:[t.jsx("button",{type:"button",onClick:()=>S(e=>!e),className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-white text-slate-700 hover:bg-slate-100","aria-label":"Attach",children:t.jsx("span",{className:"text-lg leading-none",children:"+"})}),R?t.jsxs("div",{className:"absolute bottom-12 left-2 z-20 w-52 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-xl",children:[t.jsxs("label",{className:"flex cursor-pointer items-center gap-3 px-4 py-3 text-[12px] font-semibold text-slate-700 hover:bg-slate-50",children:[t.jsx("span",{children:"Document"}),t.jsx("input",{type:"file",className:"hidden",multiple:!0,onChange:e=>b(e.target.files)})]}),t.jsxs("label",{className:"flex cursor-pointer items-center gap-3 px-4 py-3 text-[12px] font-semibold text-slate-700 hover:bg-slate-50",children:[t.jsx("span",{children:"Photos & videos"}),t.jsx("input",{type:"file",className:"hidden",multiple:!0,accept:"image/*,video/*",onChange:e=>b(e.target.files)})]}),t.jsxs("label",{className:"flex cursor-pointer items-center gap-3 px-4 py-3 text-[12px] font-semibold text-slate-700 hover:bg-slate-50",children:[t.jsx("span",{children:"Audio"}),t.jsx("input",{type:"file",className:"hidden",multiple:!0,accept:"audio/*",onChange:e=>b(e.target.files)})]})]}):null,t.jsx("input",{value:d,onChange:e=>N(e.target.value),placeholder:"Type a message",className:"w-full bg-transparent px-1 py-2 text-xs text-slate-900 placeholder:text-slate-400 focus:outline-none",onKeyDown:e=>{e.key==="Enter"&&(e.preventDefault(),A())}}),t.jsx("button",{type:"button",onClick:A,disabled:o||!d.trim()&&i.length===0,className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-emerald-500 text-white transition hover:bg-emerald-600 disabled:opacity-50","aria-label":"Send",children:t.jsx("span",{className:"text-[12px] font-black",children:"➤"})})]}),t.jsx("div",{className:"mt-2 flex items-center justify-end text-[10px] text-slate-500",children:_?"Loading…":""})]})]})]})}export{q as default};
