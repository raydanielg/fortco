import{r,j as e,H as Y}from"./app-_tcWvRHw.js";import{A as G}from"./AdminPanelLayout-0PjPupQC.js";import"./DashboardLayout-Dotb40vo.js";import"./AnimatedIcon-D_as9RWF.js";import"./index-D3vds0s7.js";import"./index-DoyJDsUh.js";function ne(){const[u,L]=r.useState(!1),[V,c]=r.useState(!1),[E,o]=r.useState(""),[b,X]=r.useState([]),[n,F]=r.useState(null),[j,v]=r.useState([]),[y,R]=r.useState(""),[d,w]=r.useState(null),[Z,O]=r.useState(null),[N,S]=r.useState(!1),[k,U]=r.useState([]),[W,D]=r.useState(""),[T,q]=r.useState("chat"),[M,H]=r.useState(!1),[x,C]=r.useState([]),[p,$]=r.useState(!0),m=r.useRef(null),B=()=>document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",h=async t=>{const s=await t.text();try{return s?JSON.parse(s):{}}catch{return{}}},f=()=>{c(!0),o(""),fetch(route("admin.helpdesk.conversations"),{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(async t=>{const s=await h(t);if(!t.ok)throw new Error(s?.message||"Failed to load conversations");X(Array.isArray(s?.conversations)?s.conversations:[]),O(new Date().toISOString())}).catch(t=>o(t?.message||"Failed to load conversations")).finally(()=>c(!1))},A=t=>{q(t),S(!0)},I=()=>{c(!0),o(""),fetch(route("admin.security.employees"),{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(async t=>{const s=await h(t);if(!t.ok)throw new Error(s?.message||"Failed to load employees");const l=Array.isArray(s?.employees)?s.employees:[];U(l)}).catch(t=>o(t?.message||"Failed to load employees")).finally(()=>c(!1))},g=t=>{t&&(c(!0),o(""),fetch(route("admin.helpdesk.messages",{user:t}),{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(async s=>{const l=await h(s);if(!s.ok)throw new Error(l?.message||"Failed to load messages");F(l?.user||null),v(Array.isArray(l?.messages)?l.messages:[]),O(new Date().toISOString())}).catch(s=>o(s?.message||"Failed to load messages")).finally(()=>c(!1)))};r.useEffect(()=>{f()},[]),r.useEffect(()=>{N&&(k.length||I())},[N]),r.useEffect(()=>{m.current&&p&&(m.current.scrollTop=m.current.scrollHeight)},[j.length,p]),r.useEffect(()=>{const t=window.setInterval(()=>{u||p&&(f(),n?.id&&g(n.id))},2500);return()=>window.clearInterval(t)},[u,n?.id,p]);const P=()=>{const t=y.trim();if(!t&&x.length===0||!n?.id)return;const s={id:`tmp-${Date.now()}`,sender:"admin",message:t,created_at:new Date().toISOString(),attachments:x.map(a=>{const i=String(a?.type||""),Q=i.startsWith("image/")||i.startsWith("video/")?"media":i.startsWith("audio/")?"audio":"document";return{id:`local-${a.name}-${a.size}-${a.lastModified}`,kind:Q,original_name:a.name,mime:i,size:a.size,url:URL.createObjectURL(a),local:!0}}),reply_to:d?{id:d.id,sender:d.sender,message:d.message,created_at:d.created_at}:null};v(a=>[...a,s]),R(""),w(null),C([]),H(!1),L(!0),o("");const l=new FormData;l.append("message",t||""),d?.id&&l.append("reply_to_id",String(d.id)),x.forEach(a=>l.append("files[]",a)),fetch(route("admin.helpdesk.reply",{user:n.id}),{method:"POST",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":B(),Accept:"application/json"},body:l}).then(async a=>{const i=await h(a);if(!a.ok)throw new Error(i?.message||i?.errors?.message?.[0]||"Failed to send");g(n.id),f()}).catch(a=>o(a?.message||"Failed to send")).finally(()=>L(!1))},_=t=>{const s=Array.from(t||[]);s.length&&C(l=>[...l,...s])},z=t=>C(s=>s.filter((l,a)=>a!==t)),K=(t,s)=>{const l=Array.isArray(t)?t:[];return l.length?e.jsx("div",{className:"mb-2 grid gap-2",children:l.map(a=>{const i=a.original_name||"Attachment";return a.kind==="media"&&String(a.mime||"").startsWith("image/")?e.jsx("a",{href:a.url,target:"_blank",rel:"noreferrer",className:"block overflow-hidden rounded-xl",children:e.jsx("img",{src:a.url,alt:i,className:"max-h-56 w-full object-cover"})},a.id):a.kind==="audio"?e.jsx("div",{className:s?"rounded-xl bg-white/10 p-2":"rounded-xl bg-slate-50 p-2",children:e.jsx("audio",{controls:!0,src:a.url,className:"w-full"})},a.id):e.jsxs("a",{href:a.url,target:"_blank",rel:"noreferrer",className:"flex items-center justify-between gap-3 rounded-xl px-3 py-2 text-[11px] "+(s?"bg-white/10 text-white":"bg-slate-50 text-slate-900"),children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate font-semibold",children:i}),e.jsx("div",{className:s?"mt-0.5 text-[10px] text-white/70":"mt-0.5 text-[10px] text-slate-500",children:a.mime||"document"})]}),e.jsx("div",{className:s?"text-[10px] text-white/70":"text-[10px] text-slate-500",children:"Open"})]},a.id)})}):null},J=[{key:"tickets",label:"Tickets",href:route("admin.support.tickets")},{key:"live-chat",label:"Live Chat",href:route("admin.support.live-chat")},{key:"knowledge-base",label:"Knowledge Base",href:route("admin.support.knowledge-base")},{key:"helpdesk-messages",label:"Helpdesk Messages",href:route("admin.support.helpdesk-messages")}];return e.jsxs(e.Fragment,{children:[e.jsx(Y,{title:"Support - Live Chat"}),e.jsxs(G,{title:"Support",active:"live-chat",items:J,children:[e.jsxs("div",{className:"border-b border-slate-200 px-6 py-4",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-900",children:"Live Chat"}),e.jsx("div",{className:"mt-1 text-[12px] text-slate-500",children:"WhatsApp-style support chat. Conversations update automatically."})]}),e.jsxs("div",{className:"p-6",children:[E?e.jsx("div",{className:"mb-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-[12px] text-red-700",children:E}):null,N?e.jsx("div",{className:"fixed inset-0 z-[80] flex items-center justify-center bg-slate-950/40 p-4",children:e.jsxs("div",{className:"w-full max-w-lg overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-xl",children:[e.jsx("div",{className:"border-b border-slate-200 px-6 py-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-slate-900",children:T==="document"?"Send document":"Start new chat"}),e.jsx("div",{className:"mt-1 text-[12px] text-slate-500",children:T==="document"?"Choose which employee you want to send the document to.":"Choose an employee to open a conversation."})]}),e.jsx("button",{type:"button",onClick:()=>S(!1),className:"rounded-xl border border-slate-200 bg-white px-3 py-2 text-[12px] font-semibold text-slate-700 hover:bg-slate-50",children:"Close"})]})}),e.jsxs("div",{className:"p-6",children:[e.jsx("input",{value:W,onChange:t=>D(t.target.value),placeholder:"Search employee by name or email",className:"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-[12px] text-slate-900 placeholder:text-slate-400 focus:border-slate-900 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-900/10"}),e.jsxs("div",{className:"mt-3 max-h-[360px] overflow-auto",children:[(k||[]).filter(t=>{const s=W.trim().toLowerCase();if(!s)return!0;const l=String(t?.full_name||"").toLowerCase(),a=String(t?.user?.email||"").toLowerCase();return l.includes(s)||a.includes(s)}).map(t=>{const s=t?.user?.id||t?.user_id;if(!s)return null;const l=!!t?.active;return e.jsxs("button",{type:"button",onClick:()=>{S(!1),D(""),q("chat"),F({id:s,name:t?.full_name||t?.user?.name||"User",email:t?.user?.email||"",active:l}),v([]),g(s)},className:"flex w-full items-center justify-between gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 text-left text-[12px] text-slate-900 hover:bg-slate-50",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"truncate font-semibold",children:t.full_name||"Employee"}),e.jsx("span",{className:l?"h-2 w-2 rounded-full bg-emerald-500":"h-2 w-2 rounded-full bg-slate-300"})]}),e.jsx("div",{className:"mt-0.5 truncate text-[11px] text-slate-500",children:t?.user?.email||""})]}),e.jsx("div",{className:"text-[11px] font-semibold text-slate-700",children:"Open"})]},t.id)}).filter(Boolean),k.length?null:e.jsx("div",{className:"py-6 text-center text-[12px] text-slate-500",children:"Loading employees…"})]})]})]})}):null,e.jsxs("div",{className:"grid gap-4 overflow-hidden rounded-2xl border border-slate-200 bg-white lg:grid-cols-[360px,1fr]",children:[e.jsxs("div",{className:"border-b border-slate-200 lg:border-b-0 lg:border-r",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[12px] font-semibold text-slate-900",children:"Chats"}),e.jsx("div",{className:"mt-0.5 text-[11px] text-slate-500",children:`${b.length} conversations`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>A("chat"),className:"inline-flex h-9 w-9 items-center justify-center rounded-xl bg-slate-900 text-white hover:bg-slate-800","aria-label":"New chat",children:e.jsx("span",{className:"text-lg leading-none",children:"+"})}),e.jsx("button",{type:"button",onClick:f,className:"rounded-lg border border-slate-200 bg-white px-3 py-2 text-[11px] font-semibold text-slate-700 hover:bg-slate-50",children:"Refresh"})]})]}),e.jsx("div",{className:"max-h-[520px] overflow-auto p-2",children:b.length?e.jsx("div",{className:"grid gap-1",children:b.map(t=>{const s=t?.user,l=String(s?.id||"")===String(n?.id||""),a=String(t?.last_message||"").slice(0,48),i=!!t?.user_active;return e.jsxs("button",{type:"button",onClick:()=>g(s?.id),className:"flex w-full items-center gap-3 rounded-xl px-3 py-2 text-left transition "+(l?"bg-slate-50":"hover:bg-slate-50"),children:[e.jsx("div",{className:"flex h-9 w-9 items-center justify-center rounded-full text-[12px] font-bold bg-slate-900 text-white",children:e.jsxs("div",{className:"relative",children:[(s?.name||"U").trim().slice(0,1).toUpperCase(),e.jsx("span",{className:"absolute -bottom-1 -right-1 h-2.5 w-2.5 rounded-full border-2 border-white"+(i?" bg-emerald-500":" bg-slate-300")})]})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:"truncate text-[12px] font-semibold text-slate-900",children:s?.name||"User"}),e.jsx("div",{className:"text-[10px] text-slate-500",children:t?.last_at?new Date(t.last_at).toLocaleTimeString():""})]}),e.jsx("div",{className:"truncate text-[11px] text-slate-500",children:a||s?.email||"—"})]})]},s?.id)})}):e.jsx("div",{className:"px-3 py-4 text-[12px] text-slate-500",children:"No chats yet."})})]}),e.jsxs("div",{className:"flex min-h-[540px] flex-col",children:[e.jsx("div",{className:"border-b border-slate-200 px-4 py-3",children:n?e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"truncate text-[12px] font-semibold text-slate-900",children:n.name}),e.jsx("span",{className:n.active?"h-2 w-2 rounded-full bg-emerald-500":"h-2 w-2 rounded-full bg-slate-300"})]}),e.jsx("div",{className:"truncate text-[11px] text-slate-500",children:n.email})]}),e.jsx("div",{className:"text-[11px] text-slate-500",children:"Online"})]}):e.jsx("div",{className:"text-[12px] text-slate-500",children:"Live Chat"})}),n?e.jsxs(e.Fragment,{children:[e.jsx("div",{ref:m,className:"flex-1 overflow-auto bg-slate-50 p-4",onScroll:()=>{const t=m.current;if(!t)return;const s=t.scrollTop+t.clientHeight>=t.scrollHeight-24;$(s)},children:j.length?e.jsx("div",{className:"grid gap-2",children:j.map(t=>{const s=t.sender==="admin";return e.jsx("div",{className:s?"flex justify-end":"flex justify-start",children:e.jsxs("div",{role:"button",tabIndex:0,onClick:()=>{!t?.id||String(t.id).startsWith("tmp-")||w(t)},onKeyDown:l=>{if(l.key==="Enter"){if(!t?.id||String(t.id).startsWith("tmp-"))return;w(t)}},className:"max-w-[85%] rounded-2xl px-4 py-3 text-[12px] leading-relaxed shadow-sm "+(s?"bg-slate-900 text-white":"bg-white text-slate-900"),children:[t.reply_to?e.jsxs("div",{className:s?"mb-2 rounded-xl bg-white/10 px-3 py-2":"mb-2 rounded-xl bg-slate-50 px-3 py-2",children:[e.jsxs("div",{className:s?"text-[10px] font-bold text-white/80":"text-[10px] font-bold text-slate-700",children:["Replying to ",t.reply_to.sender]}),e.jsx("div",{className:s?"mt-0.5 text-[10px] text-white/70":"mt-0.5 text-[10px] text-slate-500",children:String(t.reply_to.message||"").slice(0,140)})]}):null,K(t.attachments,s),t.message?e.jsx("div",{children:t.message}):null,e.jsx("div",{className:s?"mt-1 text-[10px] text-white/70":"mt-1 text-[10px] text-slate-500",children:t.created_at?new Date(t.created_at).toLocaleTimeString():""})]})},t.id)})}):e.jsx("div",{className:"text-[12px] text-slate-500",children:"No messages yet."})}),e.jsxs("div",{className:"border-t border-slate-200 bg-white p-4",children:[x.length?e.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:x.map((t,s)=>e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-[10px] font-semibold text-slate-700",children:[e.jsx("span",{className:"max-w-[160px] truncate",children:t.name}),e.jsx("button",{type:"button",onClick:()=>z(s),className:"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-[10px] font-semibold text-slate-700 hover:bg-slate-100",children:"X"})]},`${t.name}-${s}`))}):null,e.jsxs("div",{className:"relative flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-2 py-1.5",children:[e.jsx("button",{type:"button",onClick:()=>H(t=>!t),className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-white text-slate-700 hover:bg-slate-100","aria-label":"Attach",children:e.jsx("span",{className:"text-lg leading-none",children:"+"})}),M?e.jsxs("div",{className:"absolute bottom-12 left-2 z-20 w-52 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-xl",children:[e.jsxs("label",{className:"flex cursor-pointer items-center gap-3 px-4 py-3 text-[12px] font-semibold text-slate-700 hover:bg-slate-50",children:[e.jsx("span",{children:"Document"}),e.jsx("input",{type:"file",className:"hidden",multiple:!0,onChange:t=>_(t.target.files)})]}),e.jsxs("label",{className:"flex cursor-pointer items-center gap-3 px-4 py-3 text-[12px] font-semibold text-slate-700 hover:bg-slate-50",children:[e.jsx("span",{children:"Photos & videos"}),e.jsx("input",{type:"file",className:"hidden",multiple:!0,accept:"image/*,video/*",onChange:t=>_(t.target.files)})]}),e.jsxs("label",{className:"flex cursor-pointer items-center gap-3 px-4 py-3 text-[12px] font-semibold text-slate-700 hover:bg-slate-50",children:[e.jsx("span",{children:"Audio"}),e.jsx("input",{type:"file",className:"hidden",multiple:!0,accept:"audio/*",onChange:t=>_(t.target.files)})]})]}):null,e.jsx("input",{value:y,onChange:t=>R(t.target.value),placeholder:n?"Type a message":"Select a chat first",className:"w-full bg-transparent px-1 py-2 text-[12px] text-slate-900 placeholder:text-slate-400 focus:outline-none",onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),P())}}),e.jsx("button",{type:"button",onClick:P,disabled:u||!y.trim()&&x.length===0,className:"inline-flex h-9 w-9 items-center justify-center rounded-full bg-emerald-500 text-white transition hover:bg-emerald-600 disabled:opacity-50","aria-label":"Send",children:e.jsx("span",{className:"text-[12px] font-black",children:"➤"})})]}),e.jsx("div",{className:"mt-2 flex items-center justify-end text-[10px] text-slate-500",children:u?"Working…":""})]})]}):e.jsx("div",{className:"flex flex-1 items-center justify-center bg-slate-50 p-6",children:e.jsxs("div",{className:"w-full max-w-md rounded-3xl border border-slate-200 bg-white p-6 text-center shadow-sm",children:[e.jsx("div",{className:"mx-auto flex h-20 w-20 items-center justify-center rounded-2xl bg-slate-900 text-white",children:e.jsx("div",{className:"text-3xl font-black",children:"F"})}),e.jsx("div",{className:"mt-5 text-lg font-semibold text-slate-900",children:"Fortco Live Chat"}),e.jsx("div",{className:"mt-2 text-[12px] leading-relaxed text-slate-500",children:"Start a conversation to send messages faster. You can also choose an employee to send a document."}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>A("document"),className:"rounded-2xl border border-slate-200 bg-white px-4 py-4 text-left hover:bg-slate-50",children:[e.jsx("div",{className:"text-[12px] font-semibold text-slate-900",children:"Send document"}),e.jsx("div",{className:"mt-1 text-[11px] text-slate-500",children:"Choose employee"})]}),e.jsxs("button",{type:"button",onClick:()=>A("chat"),className:"rounded-2xl border border-slate-200 bg-white px-4 py-4 text-left hover:bg-slate-50",children:[e.jsx("div",{className:"text-[12px] font-semibold text-slate-900",children:"Add contact"}),e.jsx("div",{className:"mt-1 text-[11px] text-slate-500",children:"Start chat"})]})]})]})})]})]})]})]})]})}export{ne as default};
