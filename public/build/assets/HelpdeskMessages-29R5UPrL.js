import{r as n,j as e,H as T}from"./app-_tcWvRHw.js";import{A as L}from"./AdminPanelLayout-0PjPupQC.js";import"./DashboardLayout-Dotb40vo.js";import"./AnimatedIcon-D_as9RWF.js";import"./index-D3vds0s7.js";import"./index-DoyJDsUh.js";function W(){const[_,b]=n.useState(!1),[f,o]=n.useState(!1),[y,d]=n.useState(""),[v,R]=n.useState([]),[a,C]=n.useState(null),[p,j]=n.useState([]),[m,w]=n.useState(""),[r,c]=n.useState(null),[N,S]=n.useState(null),x=n.useRef(null),A=()=>document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",u=async t=>{const s=await t.text();try{return s?JSON.parse(s):{}}catch{return{}}},h=()=>{o(!0),d(""),fetch(route("admin.helpdesk.conversations"),{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(async t=>{const s=await u(t);if(!t.ok)throw new Error(s?.message||"Failed to load conversations");R(Array.isArray(s?.conversations)?s.conversations:[]),S(new Date().toISOString())}).catch(t=>d(t?.message||"Failed to load conversations")).finally(()=>o(!1))},g=t=>{t&&(o(!0),d(""),fetch(route("admin.helpdesk.messages",{user:t}),{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"}}).then(async s=>{const l=await u(s);if(!s.ok)throw new Error(l?.message||"Failed to load messages");C(l?.user||null),j(Array.isArray(l?.messages)?l.messages:[]),S(new Date().toISOString())}).catch(s=>d(s?.message||"Failed to load messages")).finally(()=>o(!1)))};n.useEffect(()=>{h()},[]),n.useEffect(()=>{x.current&&(x.current.scrollTop=x.current.scrollHeight)},[p.length]),n.useEffect(()=>{if(!a?.id)return;const t=window.setInterval(()=>g(a.id),3e3);return()=>window.clearInterval(t)},[a?.id]);const k=()=>{const t=m.trim();if(!t||!a?.id)return;const s={id:`tmp-${Date.now()}`,sender:"admin",message:t,created_at:new Date().toISOString(),reply_to:r?{id:r.id,sender:r.sender,message:r.message,created_at:r.created_at}:null};j(l=>[...l,s]),w(""),c(null),b(!0),d(""),fetch(route("admin.helpdesk.reply",{user:a.id}),{method:"POST",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":A(),Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({message:t,reply_to_id:r?.id||null})}).then(async l=>{const i=await u(l);if(!l.ok)throw new Error(i?.message||i?.errors?.message?.[0]||"Failed to send reply");g(a.id),h()}).catch(l=>d(l?.message||"Failed to send reply")).finally(()=>b(!1))},E=[{key:"tickets",label:"Tickets",href:route("admin.support.tickets")},{key:"live-chat",label:"Live Chat",href:route("admin.support.live-chat")},{key:"knowledge-base",label:"Knowledge Base",href:route("admin.support.knowledge-base")},{key:"helpdesk-messages",label:"Helpdesk Messages",href:route("admin.support.helpdesk-messages")}],D=a?.id?String(a.id):"",H=t=>{const s=t?.user,l=String(t?.last_message||"").slice(0,64),i=String(s?.id||"")===D;return e.jsxs("button",{type:"button",onClick:()=>g(s?.id),className:"w-full rounded-xl border px-4 py-3 text-left transition "+(i?"border-slate-900 bg-slate-900 text-white":"border-slate-200 bg-white text-slate-900 hover:bg-slate-50"),children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("div",{className:i?"text-[12px] font-semibold text-white":"text-[12px] font-semibold text-slate-900",children:s?.name||"User"}),e.jsx("div",{className:i?"text-[10px] text-white/70":"text-[10px] text-slate-500",children:t?.last_at?new Date(t.last_at).toLocaleString():""})]}),e.jsx("div",{className:i?"mt-1 text-[11px] text-white/80":"mt-1 text-[11px] text-slate-500",children:s?.email||""}),e.jsx("div",{className:i?"mt-2 text-[11px] text-white/80":"mt-2 text-[11px] text-slate-600",children:l||"—"})]},s?.id)};return e.jsxs(e.Fragment,{children:[e.jsx(T,{title:"Support - Helpdesk Messages"}),e.jsxs(L,{title:"Support",active:"helpdesk-messages",items:E,children:[e.jsxs("div",{className:"border-b border-slate-200 px-6 py-4",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-900",children:"Helpdesk messages"}),e.jsx("div",{className:"mt-1 text-[12px] text-slate-500",children:"View messages sent from banned users and reply."})]}),e.jsxs("div",{className:"p-6",children:[y?e.jsx("div",{className:"mb-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-[12px] text-red-700",children:y}):null,e.jsxs("div",{className:"grid gap-4 lg:grid-cols-[360px,1fr]",children:[e.jsxs("div",{className:"rounded-2xl border border-slate-200 bg-white p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-[12px] font-semibold text-slate-900",children:"Conversations"}),e.jsx("button",{type:"button",onClick:h,className:"text-[11px] font-semibold text-slate-700 hover:text-slate-900",children:"Refresh"})]}),e.jsx("div",{className:"mt-3 grid gap-2",children:v.length?v.map(H):e.jsx("div",{className:"text-[12px] text-slate-500",children:"No conversations yet."})})]}),e.jsxs("div",{className:"rounded-2xl border border-slate-200 bg-white",children:[e.jsxs("div",{className:"border-b border-slate-200 px-4 py-3",children:[e.jsx("div",{className:"text-[12px] font-semibold text-slate-900",children:a?a.name:"Select a conversation"}),e.jsx("div",{className:"mt-1 text-[11px] text-slate-500",children:a?a.email:""}),e.jsxs("div",{className:"mt-2 inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-[10px] font-semibold text-slate-700",children:[e.jsx("span",{className:f?"h-2 w-2 rounded-full bg-amber-500":"h-2 w-2 rounded-full bg-emerald-500"}),f?"Syncing…":"Up to date",e.jsx("span",{className:"font-normal text-slate-500",children:N?`• ${new Date(N).toLocaleTimeString()}`:""})]})]}),e.jsx("div",{ref:x,className:"max-h-[420px] overflow-auto p-4",children:p.length?e.jsx("div",{className:"grid gap-3",children:p.map(t=>e.jsx("div",{className:t.sender==="admin"?"flex justify-end":"flex justify-start",children:e.jsxs("div",{className:"max-w-[85%] rounded-2xl px-4 py-3 text-[12px] leading-relaxed "+(t.sender==="admin"?"bg-slate-900 text-white":"bg-slate-100 text-slate-900"),role:"button",tabIndex:0,onClick:()=>{!t?.id||String(t.id).startsWith("tmp-")||c(t)},onKeyDown:s=>{if(s.key==="Enter"){if(!t?.id||String(t.id).startsWith("tmp-"))return;c(t)}},children:[t.reply_to?e.jsxs("div",{className:t.sender==="admin"?"mb-2 rounded-xl bg-white/10 px-3 py-2":"mb-2 rounded-xl bg-white px-3 py-2",children:[e.jsxs("div",{className:t.sender==="admin"?"text-[10px] font-bold text-white/80":"text-[10px] font-bold text-slate-700",children:["Replying to ",t.reply_to.sender]}),e.jsx("div",{className:t.sender==="admin"?"mt-0.5 text-[10px] text-white/70":"mt-0.5 text-[10px] text-slate-500",children:String(t.reply_to.message||"").slice(0,140)})]}):null,e.jsx("div",{children:t.message}),e.jsx("div",{className:t.sender==="admin"?"mt-1 text-[10px] text-white/70":"mt-1 text-[10px] text-slate-500",children:t.created_at?new Date(t.created_at).toLocaleTimeString():""})]})},t.id))}):e.jsx("div",{className:"text-[12px] text-slate-500",children:"No messages yet."})}),e.jsxs("div",{className:"border-t border-slate-200 p-4",children:[r?e.jsxs("div",{className:"mb-3 flex items-start justify-between gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"text-[10px] font-bold text-slate-700",children:["Replying to ",r.sender]}),e.jsx("div",{className:"mt-0.5 truncate text-[11px] text-slate-600",children:r.message})]}),e.jsx("button",{type:"button",onClick:()=>c(null),className:"rounded-lg border border-slate-200 bg-white px-2 py-1 text-[10px] font-semibold text-slate-700 hover:bg-slate-50",children:"X"})]}):null,e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{value:m,onChange:t=>w(t.target.value),placeholder:a?"Write a reply...":"Select a conversation first",className:"w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-[12px] text-slate-900 placeholder:text-slate-400 focus:border-slate-900 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-900/10",disabled:!a,onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),k())}}),e.jsx("button",{type:"button",onClick:k,disabled:!a||!m.trim()||_,className:"rounded-xl bg-slate-900 px-4 py-2 text-[12px] font-semibold text-white hover:bg-slate-800 disabled:opacity-50",children:"Send"})]}),e.jsx("div",{className:"mt-2 text-[10px] text-slate-500",children:"Click any message bubble to reply."})]})]})]})]})]})]})}export{W as default};
